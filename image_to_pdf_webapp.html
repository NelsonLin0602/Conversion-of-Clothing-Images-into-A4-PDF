<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>圖片轉PDF - 每頁6張A4排版（修正版）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,.95);
      border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,.1); backdrop-filter: blur(10px);
    }
    h1 { text-align: center; color: #333; margin-bottom: 40px; font-size: 2.2em;
      background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .upload-section { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; text-align: center; margin-bottom: 30px; transition: .3s ease; background: rgba(102,126,234,.05); }
    .upload-section:hover { border-color:#764ba2; background: rgba(102,126,234,.1); transform: translateY(-2px); }
    .upload-section.dragover { border-color:#764ba2; background: rgba(102,126,234,.15); transform: scale(1.01); }
    .upload-icon { font-size: 3rem; color:#667eea; margin-bottom: 10px; }
    .upload-text { font-size: 1.1rem; color:#666; margin-bottom: 14px; }
    #fileInput { display:none; }
    .btn { background: linear-gradient(45deg,#667eea,#764ba2); color:#fff; border:none; padding: 12px 22px; border-radius: 20px; cursor:pointer; font-size:1rem; font-weight:600; transition: .2s ease; box-shadow: 0 4px 15px rgba(102,126,234,.3); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(102,126,234,.4); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .controls { display:flex; gap:12px; justify-content:center; margin-bottom: 20px; flex-wrap: wrap; }
    .preview-section { margin-top: 20px; }
    .preview-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px,1fr)); gap:12px; margin-bottom: 20px; }
    .preview-item { position:relative; border-radius:10px; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,.1); background:#fff; }
    .preview-item img { width:100%; height:120px; object-fit:cover; }
    .preview-item .remove-btn { position:absolute; top:6px; right:6px; background: rgba(255,0,0,.85); color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; }
    .preview-item .index { position:absolute; bottom:6px; left:6px; background: rgba(0,0,0,.65); color:#fff; padding: 2px 6px; border-radius: 10px; font-size: 12px; }
    .progress-bar { width:100%; height:6px; background: rgba(102,126,234,.2); border-radius: 3px; overflow:hidden; margin-top: 10px; display:none; }
    .progress-fill { height:100%; background: linear-gradient(45deg,#667eea,#764ba2); width:0%; transition: width .2s ease; }
    .status { text-align:center; margin-top: 10px; font-size: 1rem; color:#555; }
    .settings { background: rgba(102,126,234,.05); border-radius: 15px; padding: 16px; margin-bottom: 20px; }
    .settings h3 { color:#333; margin-bottom: 10px; text-align:center; }
    .settings-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 10px; }
    .setting-item { display:flex; flex-direction:column; }
    .setting-item label { font-weight:700; color:#555; margin-bottom: 4px; }
    .setting-item input { padding: 8px 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
    .setting-item input:focus { outline:none; border-color:#667eea; }

    /* PDF 預覽 */
    #pdfPreview { display:none; margin-top: 24px; }
    .pdf-preview-pages { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap: 16px; }
    .pdf-preview-page { background: #fff; border-radius: 10px; box-shadow: 0 6px 16px rgba(0,0,0,.1); padding: 10px; display:flex; flex-direction:column; align-items:center; }
    .pdf-preview-page canvas { width: 100%; height: auto; border-radius: 6px; }
    .page-number { margin-bottom: 6px; font-weight: 700; color:#444; }

    @media (max-width: 768px) {
      .container { padding: 20px; }
      h1 { font-size: 1.8em; }
      .upload-section { padding: 28px 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📄 圖片轉PDF工具（每頁 6 張）</h1>

    <div class="settings">
      <h3>⚙️ PDF 設定</h3>
      <div class="settings-grid">
        <div class="setting-item">
          <label for="dpiSetting">DPI解析度：</label>
          <input type="number" id="dpiSetting" value="300" min="72" max="600" />
        </div>
        <div class="setting-item">
          <label for="marginTop">上邊界 (px)：</label>
          <input type="number" id="marginTop" value="150" min="0" />
        </div>
        <div class="setting-item">
          <label for="marginBottom">下邊界 (px)：</label>
          <input type="number" id="marginBottom" value="150" min="0" />
        </div>
        <div class="setting-item">
          <label for="marginLeft">左邊界 (px)：</label>
          <input type="number" id="marginLeft" value="100" min="0" />
        </div>
        <div class="setting-item">
          <label for="marginRight">右邊界 (px)：</label>
          <input type="number" id="marginRight" value="100" min="0" />
        </div>
        <div class="setting-item">
          <label for="hSpacing">水平間距 (px)：</label>
          <input type="number" id="hSpacing" value="50" min="0" />
        </div>
        <div class="setting-item">
          <label for="vSpacing">垂直間距 (px)：</label>
          <input type="number" id="vSpacing" value="200" min="0" />
        </div>
      </div>
    </div>

    <div class="upload-section" id="uploadSection">
      <div class="upload-icon">📤</div>
      <div class="upload-text">拖曳圖片到此處或點擊選擇檔案</div>
      <button class="btn" onclick="document.getElementById('fileInput').click()">選擇圖片</button>
      <input type="file" id="fileInput" accept="image/*" multiple />
    </div>

    <div class="controls">
      <button class="btn" id="clearBtn" onclick="clearImages()">清除所有圖片</button>
      <button class="btn" id="previewBtn" onclick="showPreview()" disabled>生成預覽</button>
      <button class="btn" id="generateBtn" onclick="generatePDF()" disabled>生成PDF</button>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="status" id="status"></div>

    <div class="preview-section">
      <div class="preview-grid" id="previewGrid"></div>
    </div>

    <!-- PDF 預覽容器 -->
    <div id="pdfPreview">
      <h3 style="text-align:center; margin-bottom: 10px;">📖 PDF 預覽</h3>
      <div class="pdf-preview-pages" id="pdfPreviewPages"></div>
    </div>
  </div>

  <script>
    let images = [];

    // 設定值（與輸入框同步）
    const PDF_SETTINGS = {
      dpi: 300, marginTop: 150, marginBottom: 150,
      marginLeft: 100, marginRight: 100, hSpacing: 50, vSpacing: 200,
    };

    // 將輸入框與設定物件雙向綁定
    const bindNumberInput = (id, key) => {
      const el = document.getElementById(id);
      const update = () => {
        const v = Number(el.value);
        if (!Number.isFinite(v) || v < 0) return; // 基本防呆
        PDF_SETTINGS[key] = v;
      };
      el.addEventListener('input', update);
      update();
    };

    bindNumberInput('dpiSetting', 'dpi');
    bindNumberInput('marginTop', 'marginTop');
    bindNumberInput('marginBottom', 'marginBottom');
    bindNumberInput('marginLeft', 'marginLeft');
    bindNumberInput('marginRight', 'marginRight');
    bindNumberInput('hSpacing', 'hSpacing');
    bindNumberInput('vSpacing', 'vSpacing');

    // 檔案輸入
    document.getElementById('fileInput').addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // 拖放
    const uploadSection = document.getElementById('uploadSection');
    uploadSection.addEventListener('dragover', (e) => { e.preventDefault(); uploadSection.classList.add('dragover'); });
    uploadSection.addEventListener('dragleave', (e) => { e.preventDefault(); uploadSection.classList.remove('dragover'); });
    uploadSection.addEventListener('drop', (e) => { e.preventDefault(); uploadSection.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

    function handleFiles(fileList) {
      const fileArray = Array.from(fileList);
      if (!fileArray.length) return;

      let loadedCount = 0;
      updateStatus(`正在載入 ${fileArray.length} 張圖片…`);

      fileArray.forEach((file) => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            images.push({ src: ev.target.result, name: file.name, width: img.width, height: img.height });
            loadedCount++;
            if (loadedCount === fileArray.length) {
              updatePreview();
              updateStatus(`已載入 ${images.length} 張圖片`);
              updateButtons();
            }
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function updateButtons() {
      const hasImages = images.length > 0;
      document.getElementById('generateBtn').disabled = !hasImages;
      document.getElementById('previewBtn').disabled = !hasImages;
    }

    function updatePreview() {
      const grid = document.getElementById('previewGrid');
      grid.innerHTML = '';
      images.forEach((image, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
          <img src="${image.src}" alt="${image.name}" />
          <button class="remove-btn" aria-label="remove" title="移除這張" onclick="removeImage(${index})">×</button>
          <div class="index">${index + 1}</div>
        `;
        grid.appendChild(item);
      });
    }

    function removeImage(idx) {
      images.splice(idx, 1);
      updatePreview();
      updateStatus(`已刪除圖片，剩餘 ${images.length} 張`);
      updateButtons();
      if (!images.length) hidePDFPreview();
    }

    function clearImages() {
      images = [];
      updatePreview();
      hidePDFPreview();
      updateStatus('已清除所有圖片');
      updateButtons();
    }

    function updateStatus(msg) { document.getElementById('status').textContent = msg; }

    function showProgress(show = true) { document.getElementById('progressBar').style.display = show ? 'block' : 'none'; }

    function updateProgress(percent) { document.getElementById('progressFill').style.width = Math.max(0, Math.min(100, percent)) + '%'; }

    function hidePDFPreview() { document.getElementById('pdfPreview').style.display = 'none'; document.getElementById('pdfPreviewPages').innerHTML = ''; }

    async function showPreview() {
      if (!images.length) return;
      const previewBtn = document.getElementById('previewBtn');
      previewBtn.disabled = true; showProgress(true); updateProgress(0);
      try {
        updateStatus('正在生成預覽…');
        const pages = await generatePreviewPages();
        const preview = document.getElementById('pdfPreview');
        const container = document.getElementById('pdfPreviewPages');
        container.innerHTML = '';
        pages.forEach((p, i) => {
          const div = document.createElement('div');
          div.className = 'pdf-preview-page';
          const num = document.createElement('div'); num.className = 'page-number'; num.textContent = `第 ${i + 1} 頁`;
          const canvas = document.createElement('canvas'); canvas.width = p.width; canvas.height = p.height; canvas.getContext('2d').putImageData(p.imageData, 0, 0);
          div.appendChild(num); div.appendChild(canvas); container.appendChild(div);
        });
        preview.style.display = 'block';
        updateStatus(`✅ 預覽生成完成！共 ${pages.length} 頁，${images.length} 張圖片`);
        preview.scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        console.error(err);
        updateStatus('❌ 預覽生成失敗，請重試');
      } finally { previewBtn.disabled = false; showProgress(false); }
    }

    async function generatePreviewPages() {
      const { dpi, marginTop, marginBottom, marginLeft, marginRight, hSpacing, vSpacing } = PDF_SETTINGS;
      // A4 轉 px
      const a4WidthPx = Math.round(210 / 25.4 * dpi);
      const a4HeightPx = Math.round(297 / 25.4 * dpi);
      const usableWidth = a4WidthPx - marginLeft - marginRight - 2 * hSpacing;
      const usableHeight = a4HeightPx - marginTop - marginBottom - vSpacing;
      const cellW = Math.floor(usableWidth / 3);
      const cellH = Math.floor(usableHeight / 2);

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = a4WidthPx; canvas.height = a4HeightPx;

      const totalPages = Math.ceil(images.length / 6) || 1;
      const previewPages = [];

      for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
        updateProgress(((pageIndex) / totalPages) * 100);
        updateStatus(`正在生成第 ${pageIndex + 1} 頁預覽…`);

        ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const startIndex = pageIndex * 6; const pageImages = images.slice(startIndex, startIndex + 6);

        const positions = [];
        const y1 = marginTop; for (let i = 0; i < 3; i++) { positions.push({ x: marginLeft + i * (cellW + hSpacing), y: y1 }); }
        const y2 = marginTop + cellH + vSpacing; for (let i = 0; i < 3; i++) { positions.push({ x: marginLeft + i * (cellW + hSpacing), y: y2 }); }

        for (let i = 0; i < pageImages.length; i++) {
          const { src } = pageImages[i]; const { x, y } = positions[i];
          await new Promise((resolve) => { const img = new Image(); img.onload = () => {
            const scale = Math.min(cellW / img.width, cellH / img.height);
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale); resolve(); };
            img.src = src; });
        }
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        previewPages.push({ imageData, width: canvas.width, height: canvas.height });
        await new Promise(r => setTimeout(r, 10));
      }
      updateProgress(100);
      return previewPages;
    }

    async function generatePDF() {
      if (!images.length) return;
      const generateBtn = document.getElementById('generateBtn');
      generateBtn.disabled = true; showProgress(true); updateProgress(0);
      try {
        const { dpi, marginTop, marginBottom, marginLeft, marginRight, hSpacing, vSpacing } = PDF_SETTINGS;
        const a4WidthPx = Math.round(210 / 25.4 * dpi);
        const a4HeightPx = Math.round(297 / 25.4 * dpi);
        const usableWidth = a4WidthPx - marginLeft - marginRight - 2 * hSpacing;
        const usableHeight = a4HeightPx - marginTop - marginBottom - vSpacing;
        const cellW = Math.floor(usableWidth / 3);
        const cellH = Math.floor(usableHeight / 2);

        updateStatus('正在生成 PDF…');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = a4WidthPx; canvas.height = a4HeightPx;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const totalPages = Math.ceil(images.length / 6) || 1;

        for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
          updateProgress(((pageIndex) / totalPages) * 100);
          updateStatus(`正在處理第 ${pageIndex + 1} 頁，共 ${totalPages} 頁…`);

          if (pageIndex > 0) pdf.addPage();
          ctx.fillStyle = 'white'; ctx.fillRect(0, 0, canvas.width, canvas.height);

          const startIndex = pageIndex * 6; const pageImages = images.slice(startIndex, startIndex + 6);
          const positions = [];
          const y1 = marginTop; for (let i = 0; i < 3; i++) { positions.push({ x: marginLeft + i * (cellW + hSpacing), y: y1 }); }
          const y2 = marginTop + cellH + vSpacing; for (let i = 0; i < 3; i++) { positions.push({ x: marginLeft + i * (cellW + hSpacing), y: y2 }); }

          for (let i = 0; i < pageImages.length; i++) {
            const { src } = pageImages[i]; const { x, y } = positions[i];
            await new Promise((resolve) => { const img = new Image(); img.onload = () => {
              const scale = Math.min(cellW / img.width, cellH / img.height);
              ctx.drawImage(img, x, y, img.width * scale, img.height * scale); resolve(); };
              img.src = src; });
          }

          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          // A4 寬高（mm）固定 210 x 297
          pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
          await new Promise(r => setTimeout(r, 10));
        }

        updateProgress(100);
        const timestamp = new Date().toISOString().slice(0,19).replace(/[:-]/g,'');
        pdf.save(`圖片輸出_${timestamp}.pdf`);
        updateStatus(`✅ PDF 生成完成！共 ${Math.ceil(images.length / 6) || 1} 頁，${images.length} 張圖片`);
      } catch (err) {
        console.error('生成PDF時發生錯誤:', err);
        updateStatus('❌ PDF生成失敗，請重試');
      } finally {
        generateBtn.disabled = false; showProgress(false);
      }
    }

    // 初始狀態
    updateStatus('請上傳圖片開始使用');
  </script>
</body>
</html>
